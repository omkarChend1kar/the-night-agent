id: fix_anomaly
namespace: nightagent

inputs:
  - name: anomalyId
    type: STRING
    required: true

tasks:
  - id: analyze_and_fix
    type: io.kestra.plugin.scripts.python.Script
    inputFiles:
      analyst_agent.py: "{{ read('backend/agents/analyst_agent.py') }}"
      propose_fix_agent.py: "{{ read('backend/agents/propose_fix_agent.py') }}"
      bedrock_agent.py: "{{ read('backend/agents/bedrock_agent.py') }}"
    script: |
      import sys
      import os
      
      # Setup paths
      sys.path.append('.')
      
      # Env vars for Agents
      os.environ['API_URL'] = 'http://host.docker.internal:3001/api/internal'
      os.environ['REPO_PATH'] = os.getcwd() 
      
      from analyst_agent import AnalystAgent
      from propose_fix_agent import ProposeFixAgent
      
      anomaly_id = '{{ inputs.anomalyId }}'
      print(f"ğŸš€ Starting Fix Workflow for Anomaly {anomaly_id}")
      
      # --- STEP 1: ANALYST ---
      print("\nğŸ•µï¸â€â™€ï¸ Running Analyst Agent...")
      try:
          AnalystAgent().run(anomaly_id)
      except Exception as e:
          print(f"âŒ Analyst Agent Failed: {e}")
          sys.exit(1)
          
      print("âœ… Analysis Complete & Saved.")
      
      # --- STEP 2: PROPOSER ---
      print("\nğŸ› ï¸ Running Propose Fix Agent (Cline)...")
      
      try:
          ProposeFixAgent().run(anomaly_id)
      except Exception as e:
           print(f"âŒ Propose Fix Agent Failed: {e}")
           sys.exit(1)

      print("\nğŸ Workflow Completed.")

